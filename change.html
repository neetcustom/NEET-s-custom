<!DOCTYPE html>
<html>
<head>
  <title>カスタム戦績</title>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 8px;
      text-align: left;
      border: 1px solid #ddd;
    }
    th {
      position: relative;
      cursor: pointer;
    }
    .sort-button {
      margin-left: 5px;
      font-size: 12px;
      border: none;
      background-color: transparent;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>검색</h1>
  <form id="update-cell-form">
    <label for="cell-value">이름:</label>
    <select id="cell-value" name="cell-value">
      <!-- 옵션이 여기에 추가됩니다 -->
    </select>
    <button type="button" onclick="updateCell()">검색</button>
  </form>
  <table id="data-table">
    <thead></thead>
    <tbody></tbody>
  </table>
  <script>
    let globalData = [];
    let j3Value = '';
    function start() {
      gapi.load('client', initClient);
    }
    function initClient() {
      gapi.client.init({
        apiKey: 'AIzaSyClqiPHaLV7YaxtbupT_J3dw8yyEWVB5j8',
        discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"]
      }).then(() => {
        console.log('Google Sheets API 클라이언트 초기화 완료.');
        return gapi.client.sheets.spreadsheets.values.batchGet({
          spreadsheetId: '108gLlEpTaKI4TsHt50TdQaM-Ip8IEsADowwTAhcp2dk',
          ranges: ['戦績表示!S4:W', '戦績表示!B5:B', '戦績表示!R3']
        });
      }).then(response => {
        const data = response.result.valueRanges;
        globalData = data[0].values;
        const comboBoxData = data[1].values;
        j3Value = data[2].values[0][0];
        console.log('Google Sheets에서 데이터 가져옴:', globalData);
        sortTable(2, 'desc');
        renderTable(globalData);
        populateComboBox(comboBoxData);
      }).catch(error => {
        console.error('오류:', error);
        alert(`오류: ${error.result.error.message || error.message}`);
      });
    }

    function renderTable(data) {
      const table = document.getElementById('data-table');
      const thead = table.querySelector('thead');
      const tbody = table.querySelector('tbody');
      
      if (data && data.length > 0) {
        const headers = data[0];
        let headerRow = '<tr>';
        headers.forEach((header, index) => {
          headerRow += '<th>';
          headerRow += `${header}`;
          if (index === 2 || index === 4 || index === 5) {
            headerRow += `<button class="sort-button" onclick="sortTable(${index}, 'asc')">▲</button>`;
            headerRow += `<button class="sort-button" onclick="sortTable(${index}, 'desc')">▼</button>`;
          }
          headerRow += '</th>';
        });
        headerRow += '</tr>';
        thead.innerHTML = headerRow;
        
        let rows = '';
        for (let i = 1; i < data.length; i++) {
          let row = '<tr>';
          data[i].forEach(cell => {
            row += `<td>${cell}</td>`;
          });
          row += '</tr>';
          rows += row;
        }
        tbody.innerHTML = rows;
      } else {
        console.log('데이터가 없습니다.');
      }
    }
    function populateComboBox(data) {
      const comboBox = document.getElementById('cell-value');
      data.forEach(item => {
        const option = document.createElement('option');
        option.value = item[0];
        option.text = item[0];
        comboBox.appendChild(option);
      });
      comboBox.value = j3Value;
    }
    function sortTable(columnIndex, order) {
      if (!globalData || globalData.length === 0) {
        console.log('정렬할 데이터가 없습니다.');
        return;
      }
      const headers = globalData[0];
      const rows = globalData.slice(1);
      rows.sort((a, b) => {
        const valA = a[columnIndex] || '';
        const valB = b[columnIndex] || '';
        const numA = parseFloat(valA);
        const numB = parseFloat(valB);
        const isNumA = !isNaN(numA);
        const isNumB = !isNaN(numB);
        let comparison = 0;
        if (isNumA && isNumB) {
          comparison = numA - numB;
        } else {
          comparison = valA.localeCompare(valB);
        }
        return order === 'asc' ? comparison : -comparison;
      });
      globalData = [headers, ...rows];
      renderTable(globalData);
    }
    gapi.load('client', start);
  </script>
  <script>
    function updateCell() {
      const cellValue = document.getElementById('cell-value').value;
      const scriptUrl = 'https://script.google.com/macros/s/AKfycbzyouHkiFsbEzh-lDIUPZAK2oa5oAij3GqxoE3wAvhSzmv4Th_VCZRdtYLUJzbg09ny/exec?value=' + encodeURIComponent(cellValue);
      fetch(scriptUrl)
        .then(response => response.text())
        .then(data => {
          console.log('서버 응답:', data);
          alert('J3 셀 업데이트 완료: ' + data);
          // 페이지를 새로 고침하지 않도록 하기 위해 이 라인을 주석 처리합니다.
          // location.reload();
        })
        .catch(error => {
          console.error('셀 업데이트 중 오류 발생:', error);
          alert('셀 업데이트 중 오류 발생');
        });
    }
  </script>
</body>
</html>
