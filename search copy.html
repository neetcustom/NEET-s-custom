<!DOCTYPE html>
<html>
<head>
  <title>Google Sheets to HTML Table</title>
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 8px;
      text-align: left;
      border: 1px solid #ddd;
    }
    th {
      position: relative;
      cursor: pointer;
    }
    .sort-button {
      margin-left: 5px;
      font-size: 12px;
      border: none;
      background-color: transparent;
      cursor: pointer;
    }
  </style>
</head>
<body>
    <h1>検索</h1>
  
    <form id="update-cell-form">
      <label for="cell-value"> 名前:</label>
      <select id="cell-value" name="cell-value">
        <!-- 옵션이 여기 추가됩니다 -->
      </select>
      <button type="button" onclick="updateCell()">検索</button>
    </form>
  
    <table id="data-table">
      <thead></thead>
      <tbody></tbody>
    </table>
  
    <script>
      let globalData = []; // 데이터를 전역 변수로 저장
      let j3Value = ''; // J3 셀 값을 저장할 변수
  
      async function fetchData() {
        try {
          const response = await fetch('https://your-app-name.herokuapp.com/sheets');
          const data = await response.json();
          globalData = data.values; // 데이터를 전역 변수에 저장
          console.log('Google Sheets에서 데이터 가져옴:', globalData);
          sortTable(2, 'desc'); // 기본적으로 L열(인덱스 2) 기준으로 내림차순 정렬
          renderTable(globalData);
          fetchComboBoxData();
        } catch (error) {
          console.error('Error fetching data:', error);
          alert(`Error: ${error.message}`);
        }
      }
  
      async function fetchComboBoxData() {
        try {
          const response = await fetch('https://your-app-name.herokuapp.com/sheets?range=戦績表示!B5:B');
          const data = await response.json();
          populateComboBox(data.values);
          fetchJ3Value();
        } catch (error) {
          console.error('Error fetching combobox data:', error);
          alert(`Error: ${error.message}`);
        }
      }
  
      async function fetchJ3Value() {
        try {
          const response = await fetch('https://your-app-name.herokuapp.com/sheets?range=戦績表示!J3');
          const data = await response.json();
          j3Value = data.values[0][0]; // J3 셀 값 저장
          document.getElementById('cell-value').value = j3Value;
        } catch (error) {
          console.error('Error fetching J3 value:', error);
          alert(`Error: ${error.message}`);
        }
      }
  
      function renderTable(data) {
        const table = document.getElementById('data-table');
        const thead = table.querySelector('thead');
        const tbody = table.querySelector('tbody');
        
        if (data && data.length > 0) {
          // 테이블 헤더 생성
          const headers = data[0];
          let headerRow = '<tr>';
          headers.forEach((header, index) => {
            headerRow += '<th>';
            headerRow += `${header}`;
            if (index === 2 || index === 4 || index === 5) { // L열 (인덱스 2), N열 (인덱스 4), O열 (인덱스 5) 에 버튼 추가
              headerRow += `<button class="sort-button" onclick="sortTable(${index}, 'asc')">▲</button>`;
              headerRow += `<button class="sort-button" onclick="sortTable(${index}, 'desc')">▼</button>`;
            }
            headerRow += '</th>';
          });
          headerRow += '</tr>';
          thead.innerHTML = headerRow;
          
          // 테이블 행 생성
          let rows = '';
          for (let i = 1; i < data.length; i++) {
            let row = '<tr>';
            data[i].forEach(cell => {
              row += `<td>${cell}</td>`;
            });
            row += '</tr>';
            rows += row;
          }
          tbody.innerHTML = rows;
        } else {
          console.log('데이터가 없습니다.');
        }
      }
  
      function populateComboBox(data) {
        const comboBox = document.getElementById('cell-value');
        data.forEach(item => {
          const option = document.createElement('option');
          option.value = item[0];
          option.text = item[0];
          comboBox.appendChild(option);
        });
      }
  
      function sortTable(columnIndex, order) {
        if (!globalData || globalData.length === 0) {
          console.log('정렬할 데이터가 없습니다.');
          return;
        }
  
        // 헤더 행을 건너뛰고 정렬
        const headers = globalData[0];
        const rows = globalData.slice(1);
  
        rows.sort((a, b) => {
          const valA = a[columnIndex] || '';
          const valB = b[columnIndex] || '';
  
          // 숫자로 변환할 수 있는 경우 숫자로 변환
          const numA = parseFloat(valA);
          const numB = parseFloat(valB);
          const isNumA = !isNaN(numA);
          const isNumB = !isNaN(numB);
  
          let comparison = 0;
          if (isNumA && isNumB) {
            comparison = numA - numB;
          } else {
            comparison = valA.localeCompare(valB);
          }
  
          return order === 'asc' ? comparison : -comparison;
        });
  
        // 정렬된 데이터를 다시 조립
        globalData = [headers, ...rows]; // 전역 변수에 저장
        renderTable(globalData);
      }
  
      function updateCell() {
        const cellValue = document.getElementById('cell-value').value;
        const scriptUrl = 'https://script.google.com/macros/s/AKfycbzyouHkiFsbEzh-lDIUPZAK2oa5oAij3GqxoE3wAvhSzmv4Th_VCZRdtYLUJzbg09ny/exec?value=' + encodeURIComponent(cellValue);
        fetch(scriptUrl)
          .then(response => response.text())
          .then(data => {
            console.log(data);
            alert('J3 셀 업데이트 완료');
            location.reload(); // 페이지 새로고침
          })
          .catch(error => {
            console.error('셀 업데이트 중 오류 발생:', error);
            alert('셀 업데이트 중 오류 발생');
          });
      }
  
      window.onload = fetchData;
    </script>
  </body>
</html>